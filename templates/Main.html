<!DOCTYPE html>
<html lang="en">
<body>
    <div id="mySidebar" class="sidebar">
        <h2>NBA Travel Search</h2>
        <form id="searchForm">
            <div class="form-group">
                <label for="playerNameInput">Enter Player/Team Name:</label>
                <input type="text" id="playerNameInput" class="form-control" placeholder="Enter name" required>
            </div>
            <div class="form-group">
                <label for="seasonSelection">Select Season:</label>
                <select id="seasonSelection" class="form-control">
                    <option value="2023-24">2023-24</option>
                    <option value="2022-23">2022-23</option>
                    <option value="2021-22">2021-22</option>
                    <option value="2020-21">2020-21</option>
                    <option value="2019-20">2019-20</option>
                    <option value="2018-19">2018-19</option>
                    <option value="2017-18">2017-18</option>
                    <option value="2016-17">2016-17</option>
                    <option value="2015-16">2015-16</option>
                    <option value="2014-15">2014-15</option>
                    <option value="2013-14">2013-14</option>
                </select>
            </div>
            <button type="submit" class="btn-search">Search</button>
        </form>

        <div class="theme-switch-wrapper mt-4">
            <label class="theme-switch" for="darkModeToggle">
                <input type="checkbox" id="darkModeToggle" />
                <div class="slider round"></div>
            </label>
            <em>Dark Mode</em>
        </div>

        <div class="theme-switch-wrapper mt-3">
            <label class="theme-switch" for="playoffsOnlyToggle">
                <input type="checkbox" id="playoffsOnlyToggle" />
                <div class="slider round"></div>
            </label>
            <em>Show Only Playoffs</em>
        </div>

        <div class="theme-switch-wrapper mt-3">
            <label class="theme-switch" for="removeTravelInfoToggle">
                <input type="checkbox" id="removeTravelInfoToggle" />
                <div class="slider round"></div>
            </label>
            <em>Toggle Marker Transparency</em>
        </div>

        <a href="#">About</a>
    </div>

    <div id="main">
        <div id="map"></div>
        <div id="totalMiles">
            Total distance: 0.00 km<br>
            Total fuel usage: 0.00 - 0.00 gallons<br>
            Total emissions: 0.00 - 0.00 kg CO2<br>
            Total team fuel cost: $0.00 - $0.00
        </div>
    </div>

    <button class="toggle-btn" onclick="toggleSidebar()">☰</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-providers@latest/leaflet-providers.js"></script>
    <script src="https://unpkg.com/leaflet.animatedmarker@latest/dist/AnimatedMarker.min.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@latest/dist/leaflet.polylineDecorator.js"></script>

    <script>
        var map = L.map('map').setView([37.0902, -95.7129], 4);

        // Default Tile Layer
        var defaultLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 30,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Dark Mode Tile Layer
        var darkLayer = L.tileLayer.provider('Stadia.AlidadeSmoothDark', {
            maxZoom: 30,
            attribution: 'Map tiles by Stadia Maps, under ODbL.'
        });

        document.getElementById('darkModeToggle').addEventListener('change', function (e) {
            if (this.checked) {
                map.removeLayer(defaultLayer);
                darkLayer.addTo(map);
            } else {
                map.removeLayer(darkLayer);
                defaultLayer.addTo(map);
            }
        });

        var planeIcon = L.icon({
            iconUrl: 'static/img/plane.png',
            iconSize: [32, 32],
            iconAnchor: [16, 16],
            popupAnchor: [0, -16]
        });

        var planeMarker = null;
        var polylineLayers = [];
        var allMarkers = [];
        var currentSearchId = 0;

        // Event listener for the search form
        document.getElementById('searchForm').addEventListener('submit', function (e) {
            e.preventDefault();
            resetMap();  // Reset the map at the start of a new search

            var playerName = document.getElementById('playerNameInput').value.trim();
            var selectedSeason = document.getElementById('seasonSelection').value;
            var playoffsOnly = document.getElementById('playoffsOnlyToggle').checked;

            var apiUrl = `/api/player-travel-data?name=${encodeURIComponent(playerName)}&season=${selectedSeason}&playoffsOnly=${playoffsOnly}`;

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('Data received:', data);
                    if (!data || !data.Games || !Array.isArray(data.Games)) {
                        throw new Error('Unexpected format or no data');
                    }

                    let games = data.Games;
                    if (games.length === 0) {
                        throw new Error('No travel data available for this search');
                    }

                    // Start animating through the games
                    handleTravelData(games, 0);
                })
                .catch(error => {
                    console.error(error);
                    alert(error.message);
                });
        });

        function resetMap() {
            if (planeMarker) {
                map.removeLayer(planeMarker);
                planeMarker = null;
            }
            polylineLayers.forEach(layer => map.removeLayer(layer));
            polylineLayers = [];
        }

        function animateMovement(start, end, callback) {
            var startTime = performance.now();
            var duration = 2000; // Duration of the animation (2 seconds)
            
            function animate(now) {
                var elapsedTime = now - startTime;
                var t = Math.min(1, elapsedTime / duration); // Progress ratio (0 to 1)
                
                // Calculate the next position based on the progress
                var nextPos = [
                    start[0] + t * (end[0] - start[0]),
                    start[1] + t * (end[1] - start[1])
                ];
                planeMarker.setLatLng(nextPos);

                if (t < 1) {
                    window.requestAnimationFrame(animate);
                } else {
                    if (callback) callback();  // Call the callback after animation is done
                }
            }

            // Start the animation
            window.requestAnimationFrame(animate);
        }

        function handleTravelData(games, index, lastPosition = null) {
            if (index >= games.length) return;  // End recursion when all games are processed

            const segment = games[index];
            const startCoords = lastPosition ? lastPosition : segment.start.coords;  // Use last position if available, else start.coords
            const endCoords = segment.end.coords;

            if (!planeMarker) {
                planeMarker = L.marker(startCoords, { icon: planeIcon }).addTo(map);
            }

            // Skip handling popups and polylines for now
            console.log(segment.type === "home" ? "Home Game:" : "Away Game or Travel:", segment.matchup, 'on', segment.date);

            // Animate the plane from start to end coordinates
            animateMovement(startCoords, endCoords, () => {
                // Once the animation is done, move to the next game
                setTimeout(() => handleTravelData(games, index + 1, endCoords), 1000);  // Pass the endCoords as lastPosition
            });
        }



            </script>
        </body>
        </html>